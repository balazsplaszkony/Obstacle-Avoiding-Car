/*
 * collision.c
 *
 *  Created on: 2023. mÃ¡j. 14.
 *      Author: plasz
 */
#include "collision.h"


CollisionType DetectCollision(){
	if( hasCarParametersChanged() && car.direction == GOFORWARD &&
			isRPMDrop(Encoder_left) && isRPMDrop(Encoder_right))
		car.collision = FrontalCollision;

	else if( hasCarParametersChanged() && car.direction == GOBACKWARD &&
			isRPMDrop(Encoder_left) && isRPMDrop(Encoder_right))
		car.collision = RearCollision;

	else if( hasCarParametersChanged() && car.direction == TURNRIGHTSTATIONARY &&
			((abs(Encoder_left.RPM - Encoder_left.RPM_prev) > Maximum_Tolerated_RPM_Drop) ||
			(abs(Encoder_right.RPM - Encoder_right.RPM_prev) > Maximum_Tolerated_RPM_Drop)))
			car.collision = RightCollision;

	else if( hasCarParametersChanged() && car.direction == TURNRIGHT &&
			((abs(Encoder_left.RPM - Encoder_left.RPM_prev) > Maximum_Tolerated_RPM_Drop) ||
			(abs(Encoder_right.RPM - Encoder_right.RPM_prev) > Maximum_Tolerated_RPM_Drop)))
			car.collision = LeftCollision;

	else if( hasCarParametersChanged() && car.direction == TURNLEFTSTATIONARY &&
			((abs(Encoder_left.RPM - Encoder_left.RPM_prev) > Maximum_Tolerated_RPM_Drop) ||
			(abs(Encoder_right.RPM - Encoder_right.RPM_prev) > Maximum_Tolerated_RPM_Drop)))
			car.collision = LeftCollision;

	else if( hasCarParametersChanged() && car.direction == TURNLEFTSTATIONARY &&
			((abs(Encoder_left.RPM - Encoder_left.RPM_prev) > Maximum_Tolerated_RPM_Drop) ||
			(abs(Encoder_right.RPM - Encoder_right.RPM_prev) > Maximum_Tolerated_RPM_Drop)))
			car.collision = LeftCollision;

	//TODO folytatni

	return car.collision;
}
bool hasCarParametersChanged(){
	return (!((car.direction == car_prev.direction) && ((car.tempomat && car.speed == car_prev.speed) ||
			(!car.tempomat && car.duty == car_prev.duty))));
}

bool isRPMDrop(Encoder encoder)
{
	return ((abs(encoder.RPM -encoder.RPM_prev)/encoder.RPM_prev) > 0.5);
}
